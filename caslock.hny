def cas(p, old, new):
  atomically:
    result = !p == old
    if result:
      !p = new